{{!-- Quality Coach Companion - Floating Chat Widget --}}
{{!-- Server-side beta access is handled by /api/v1/access/check.
    No API keys or email lists should be injected into the browser. --}}

{{#if @member}}
    <div id="qc-access-message" class="qc-access-message" role="status"></div>
    
    {{!-- Floating Chat Widget --}}
    <div id="quality-coach-widget" class="qc-widget qc-widget--initializing">

        {{!-- Chat Button (initially visible) --}}
        <button 
            id="qc-chat-button" 
            class="qc-chat-button is-loading" 
            type="button"
            aria-label="Open Quality Coach Companion"
            aria-haspopup="dialog"
            aria-controls="qc-chat-window"
            aria-expanded="false"
            aria-disabled="true"
            title="Checking Companion access">
            <span class="qc-chat-button-icon qc-chat-button-icon--chat" aria-hidden="true">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            </span>
            <span class="qc-chat-button-icon qc-chat-button-icon--close" aria-hidden="true">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </span>
            <span class="qc-button-badge">Beta</span>
        </button>

        {{!-- Chat Window (hidden by default) --}}
        <div id="qc-chat-window" class="qc-chat-window" role="dialog" aria-modal="true" aria-label="Quality Coach Companion">
            <div class="qc-window-handle" aria-hidden="true">
                <span></span>
            </div>
            {{!-- Header --}}
            <div class="qc-window-header">
                <div class="qc-header-content">
                    <div class="qc-header-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M2 17L12 22L22 17" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M2 12L12 17L22 12" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="qc-header-text">
                        <h3>Quality Coach Companion</h3>
                        <p>Get guidance in the flow of work</p>
                    </div>
                </div>
                <button id="qc-close-button" class="qc-close-button" aria-label="Close chat">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            {{!-- Messages Area --}}
            <div id="qc-messages" class="qc-messages">
                <div class="qc-welcome-message">
                    <div class="qc-welcome-icon">ðŸ‘‹</div>
                    <p><strong>Hi! I'm the Quality Coach Companion</strong></p>
                    <p>I'm grounded in "The Quality Coach's Handbook". Ask about systems thinking, coaching moves, or designing your next small bet.</p>
                    <div class="qc-quick-actions">
                        <button id="qc-feedback-chip" class="qc-feedback-chip" type="button">
                            Share Companion feedback
                        </button>
                    </div>
                    <p class="qc-feedback-hint">Tap to prefill "Feedback:" so you can send beta notes without leaving this chat.</p>
                </div>
            </div>

            {{!-- Typing Indicator --}}
            <div id="qc-typing" class="qc-typing" style="display: none;">
                <div class="qc-typing-dot"></div>
                <div class="qc-typing-dot"></div>
                <div class="qc-typing-dot"></div>
            </div>

            {{!-- Input Area --}}
            <div class="qc-input-area">
                <textarea 
                    id="qc-input" 
                    class="qc-input" 
                    placeholder="Ask a question..."
                    rows="1"
                    maxlength="500"></textarea>
                <button id="qc-send" class="qc-send-button" aria-label="Send message">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>

            {{!-- Footer --}}
            <div class="qc-window-footer">
                <span>Powered by The Quality Coach's Handbook</span>
            </div>
        </div>

        <script>
        (function() {
            const API_BASE = 'https://qchb-chat.fly.dev';
            const ACCESS_URL = `${API_BASE}/api/v1/access/check`;
            const CHAT_URL = `${API_BASE}/api/v1/chat`;
            const memberEmail = '{{@member.email}}';
            const isPaidMember = {{#if @member.paid}}true{{else}}false{{/if}};
            const FEEDBACK_PREFIX = 'feedback:';

            const accessMessage = document.getElementById('qc-access-message');
            const widgetContainer = document.getElementById('quality-coach-widget');
            const chatButton = document.getElementById('qc-chat-button');
            const chatWindow = document.getElementById('qc-chat-window');
            const closeButton = document.getElementById('qc-close-button');
            const messages = document.getElementById('qc-messages');
            const input = document.getElementById('qc-input');
            const sendButton = document.getElementById('qc-send');
            const typingIndicator = document.getElementById('qc-typing');
            const feedbackChip = document.getElementById('qc-feedback-chip');

            if (!chatButton || !chatWindow || !input || !sendButton || !closeButton) {
                return;
            }

            let accessToken = null;
            let hasAccess = false;
            let isOpen = false;
            let isLocked = false;
            let conversationHistory = [];
            let sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            chatButton.classList.add('is-loading');

            if (feedbackChip) {
                feedbackChip.addEventListener('click', function() {
                    const prefixText = 'Feedback: ';
                    if (!input.value.toLowerCase().startsWith(FEEDBACK_PREFIX)) {
                        input.value = prefixText;
                    }
                    input.focus();
                    input.dispatchEvent(new Event('input'));
                    showStatus('Thanks! Share what you need from the Companion and press send.', 'info');
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'quality_coach_feedback_chip_clicked', {
                            'post_slug': '{{slug}}',
                            'post_title': '{{title}}'
                        });
                    }
                });
            }

            initializeAccess();

            function showStatus(message, variant = 'info') {
                if (!accessMessage) return;
                if (!message) {
                    accessMessage.textContent = '';
                    accessMessage.style.display = 'none';
                    accessMessage.className = 'qc-access-message';
                    return;
                }
                accessMessage.textContent = message;
                accessMessage.style.display = 'flex';
                accessMessage.className = `qc-access-message qc-${variant}`;
            }

            async function initializeAccess() {
                showStatus('Checking Companion accessâ€¦');
                try {
                    const response = await fetch(ACCESS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: memberEmail,
                            is_paid_member: isPaidMember
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Access check failed');
                    }

                    const data = await response.json();
                    if (widgetContainer) {
                        widgetContainer.classList.remove('qc-widget--initializing');
                    }

                    if (!data.has_access || !data.access_token) {
                        hasAccess = false;
                        isLocked = true;
                        setButtonAccessibility({ disabled: true, loading: false, tooltip: data.reason || 'Quality Coach Companion is available to beta testers only right now.' });
                        showStatus(data.reason || 'Quality Coach Companion is available to beta testers only right now.', 'warning');
                        return;
                    }

                    accessToken = data.access_token;
                    hasAccess = true;
                    isLocked = false;
                    window.QUALITY_COACH_SESSION = {
                        token: accessToken,
                        expires_at: data.access_expires_at,
                        granted_via: data.access_granted_via,
                        email: memberEmail
                    };

                    setButtonAccessibility({ disabled: false, loading: false, tooltip: 'Open Quality Coach Companion' });
                    showStatus('');
                } catch (error) {
                    hasAccess = false;
                    isLocked = true;
                    if (widgetContainer) {
                        widgetContainer.classList.remove('qc-widget--initializing');
                    }
                    setButtonAccessibility({ disabled: true, loading: false, tooltip: 'Unable to verify beta access. Please refresh and try again.' });
                    showStatus('Unable to verify beta access. Please refresh and try again.', 'error');
                }
            }

            function setButtonAccessibility({ disabled, loading, tooltip }) {
                if (!chatButton) return;
                chatButton.classList.toggle('is-loading', Boolean(loading));
                if (typeof disabled !== 'undefined') {
                    if (disabled) {
                        chatButton.setAttribute('aria-disabled', 'true');
                        chatButton.disabled = true;
                    } else {
                        chatButton.removeAttribute('aria-disabled');
                        chatButton.disabled = false;
                    }
                }
                if (tooltip) {
                    chatButton.setAttribute('title', tooltip);
                } else {
                    chatButton.removeAttribute('title');
                }
            }

            // Toggle chat window
            chatButton.addEventListener('click', function() {
                if (chatButton.getAttribute('aria-disabled') === 'true') {
                    const lockedCopy = isLocked
                        ? 'Quality Coach Companion is limited to approved members. Reach out to join the beta.'
                        : 'Still checking your Companion accessâ€¦';
                    showStatus(lockedCopy, isLocked ? 'warning' : 'info');
                    return;
                }

                if (isOpen) {
                    closeChatWindow();
                } else {
                    openChatWindow();
                }
            });

            closeButton.addEventListener('click', closeChatWindow);

            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && isOpen) {
                    closeChatWindow();
                }
            });

            function openChatWindow() {
                if (!hasAccess) {
                    showStatus('Quality Coach Companion is limited to approved members. Reach out to join the beta.', 'warning');
                    return;
                }
                isOpen = true;
                chatWindow.classList.add('is-visible');
                chatButton.classList.add('is-open');
                chatButton.setAttribute('aria-expanded', 'true');
                chatButton.setAttribute('aria-label', 'Close Quality Coach Companion');
                input.focus();

                if (typeof gtag !== 'undefined') {
                    gtag('event', 'quality_coach_opened', {
                        'post_slug': '{{slug}}',
                        'post_title': '{{title}}'
                    });
                }
            }

            function closeChatWindow() {
                isOpen = false;
                chatWindow.classList.remove('is-visible');
                chatButton.classList.remove('is-open');
                chatButton.setAttribute('aria-expanded', 'false');
                chatButton.setAttribute('aria-label', 'Open Quality Coach Companion');
                chatButton.focus();
            }

            // Auto-resize textarea
            input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Send on Enter (Shift+Enter for newline)
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            sendButton.addEventListener('click', sendMessage);

            function sendMessage() {
                if (!hasAccess || !accessToken) {
                    showStatus('Your Companion access token expired. Refresh the page to request a new one.', 'warning');
                    return;
                }

                const message = input.value.trim();
                const isFeedback = message.toLowerCase().startsWith(FEEDBACK_PREFIX);
                if (!message) return;

                if (isFeedback && message.length <= FEEDBACK_PREFIX.length) {
                    showStatus('Add a short note after â€œFeedback:â€ before sending.', 'warning');
                    return;
                }

                if (isFeedback) {
                    showStatus('Appreciate the Companion feedback â€” it will go straight to Anne-Marie.', 'info');
                }

                addMessage(message, 'user');
                input.value = '';
                input.style.height = 'auto';

                input.disabled = true;
                sendButton.disabled = true;
                typingIndicator.style.display = 'flex';

                fetch(CHAT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId,
                        history: conversationHistory,
                        context: {
                            post_slug: '{{slug}}',
                            post_title: '{{title}}',
                            member_email: memberEmail,
                            is_feedback: isFeedback
                        }
                    })
                })
                .then(async response => {
                    typingIndicator.style.display = 'none';

                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            hasAccess = false;
                            isLocked = true;
                            showStatus('Your Companion access expired. Refresh the page to request a new token.', 'warning');
                            setButtonAccessibility({ disabled: true, loading: false, tooltip: 'Access expired - refresh to continue.' });
                        }
                        throw new Error('Chat request failed');
                    }

                    const data = await response.json();
                    if (data.answer) {
                        addMessage(data.answer, 'assistant', data.sources, data.small_bet);
                        conversationHistory.push({ role: 'user', content: message });
                        conversationHistory.push({ role: 'assistant', content: data.answer });
                        if (isFeedback && typeof gtag !== 'undefined') {
                            gtag('event', 'quality_coach_feedback_submitted', {
                                'post_slug': '{{slug}}',
                                'post_title': '{{title}}'
                            });
                        }
                    } else {
                        addMessage('Sorry, I encountered an error. Please try again.', 'error', null, null);
                    }
                })
                .catch(() => {
                    typingIndicator.style.display = 'none';
                    addMessage('Sorry, I\'m having trouble connecting. Please try again later.', 'error');
                })
                .finally(() => {
                    input.disabled = false;
                    sendButton.disabled = false;
                    input.focus();
                });
            }

            function formatMessage(content) {
                return content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/^- (.*?)$/gm, 'â€¢ $1')
                    .replace(/\[(.*?)\]/g, '<span style="color: #64748b; font-size: 0.9em;">[$1]</span>')
                    .replace(/\n/g, '<br>');
            }

            function addMessage(content, role, sources, smallBet) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'qc-message qc-message-' + role;

                const bubble = document.createElement('div');
                bubble.className = 'qc-message-bubble';

                if (role === 'user') {
                    bubble.textContent = content;
                } else {
                    bubble.innerHTML = formatMessage(content);
                }

                messageDiv.appendChild(bubble);

                if (smallBet) {
                    const betDiv = document.createElement('div');
                    betDiv.className = 'qc-small-bet';
                    betDiv.innerHTML = `
                        <div class="qc-bet-header">ðŸ’¡ Small Bet Suggestion</div>
                        <div class="qc-bet-content">
                            ${smallBet.objective ? `<div class="qc-bet-section"><strong>Objective:</strong> ${smallBet.objective}</div>` : ''}
                            ${smallBet.assumption_being_tested ? `<div class="qc-bet-section"><strong>Testing:</strong> ${smallBet.assumption_being_tested}</div>` : ''}
                            ${smallBet.steps && smallBet.steps.length > 0 ? `
                                <div class="qc-bet-section">
                                    <strong>Steps:</strong>
                                    <ol class="qc-bet-list">
                                        ${smallBet.steps.map(step => `<li>${step}</li>`).join('')}
                                    </ol>
                                </div>
                            ` : ''}
                            ${smallBet.signals_to_look_for && smallBet.signals_to_look_for.length > 0 ? `
                                <div class="qc-bet-section">
                                    <strong>Look for:</strong>
                                    <ul class="qc-bet-list">
                                        ${smallBet.signals_to_look_for.map(signal => `<li>${signal}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${smallBet.time_investment ? `<div class="qc-bet-section"><strong>Time:</strong> ${smallBet.time_investment}</div>` : ''}
                        </div>
                    `;
                    messageDiv.appendChild(betDiv);
                }

                if (sources && sources.length > 0) {
                    const sourcesDiv = document.createElement('div');
                    sourcesDiv.className = 'qc-sources';
                    sourcesDiv.innerHTML = '<strong>Sources:</strong> ' + 
                        sources.map(s => s.chapter || s.title).join(', ');
                    messageDiv.appendChild(sourcesDiv);
                }

                messages.appendChild(messageDiv);
                messages.scrollTop = messages.scrollHeight;
            }
        })();
        </script>
    </div>
{{else}}
    <div class="qc-locked-message">
        The Quality Coach Companion is available to members only. Sign in to request beta access.
    </div>
{{/if}}
