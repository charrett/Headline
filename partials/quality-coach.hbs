{{!-- Quality Coach AI - Floating Chat Widget --}}
{{!-- Server-side beta access is handled by /api/v1/access/check.
    No API keys or email lists should be injected into the browser. --}}
<style>
    .qc-access-message {
        display: none;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        border-radius: 12px;
        background: #f1f5f9;
        color: #0f172a;
        font-size: 0.95rem;
        font-weight: 500;
    }

    .qc-access-message.qc-warning {
        background: #fff7ed;
        color: #9a3412;
    }

    .qc-access-message.qc-error {
        background: #fee2e2;
        color: #b91c1c;
    }

    .qc-locked-message {
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 12px;
        background: #f8fafc;
        color: #0f172a;
        text-align: center;
        font-size: 0.95rem;
    }
</style>

{{#if @member}}
    <div id="qc-access-message" class="qc-access-message" role="status"></div>
    
    {{!-- Floating Chat Widget --}}
    <div id="quality-coach-widget" style="display: none;">

        {{!-- Chat Button (initially visible) --}}
        <button id="qc-chat-button" class="qc-chat-button" aria-label="Open Quality Coach AI">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <span class="qc-button-badge">AI</span>
        </button>

        {{!-- Chat Window (hidden by default) --}}
        <div id="qc-chat-window" class="qc-chat-window" style="display: none;">
            {{!-- Header --}}
            <div class="qc-window-header">
                <div class="qc-header-content">
                    <div class="qc-header-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M2 17L12 22L22 17" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M2 12L12 17L22 12" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="qc-header-text">
                        <h3>Quality Coach AI</h3>
                        <p>Ask me anything</p>
                    </div>
                </div>
                <button id="qc-close-button" class="qc-close-button" aria-label="Close chat">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            {{!-- Messages Area --}}
            <div id="qc-messages" class="qc-messages">
                <div class="qc-welcome-message">
                    <div class="qc-welcome-icon">ðŸ‘‹</div>
                    <p><strong>Hi! I'm your Quality Coach AI</strong></p>
                    <p>I'm trained on "The Quality Coach's Handbook". Ask me about quality coaching, systems thinking, or building quality culture.</p>
                </div>
            </div>

            {{!-- Typing Indicator --}}
            <div id="qc-typing" class="qc-typing" style="display: none;">
                <div class="qc-typing-dot"></div>
                <div class="qc-typing-dot"></div>
                <div class="qc-typing-dot"></div>
            </div>

            {{!-- Input Area --}}
            <div class="qc-input-area">
                <textarea 
                    id="qc-input" 
                    class="qc-input" 
                    placeholder="Ask a question..."
                    rows="1"
                    maxlength="500"></textarea>
                <button id="qc-send" class="qc-send-button" aria-label="Send message">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>

            {{!-- Footer --}}
            <div class="qc-window-footer">
                <span>Powered by The Quality Coach's Handbook</span>
            </div>
        </div>

        <script>
        (function() {
            const API_BASE = 'https://qchb-chat.fly.dev';
            const ACCESS_URL = `${API_BASE}/api/v1/access/check`;
            const CHAT_URL = `${API_BASE}/api/v1/chat`;
            const memberEmail = '{{@member.email}}';
            const isPaidMember = {{#if @member.paid}}true{{else}}false{{/if}};

            const accessMessage = document.getElementById('qc-access-message');
            const widgetContainer = document.getElementById('quality-coach-widget');
            const chatButton = document.getElementById('qc-chat-button');
            const chatWindow = document.getElementById('qc-chat-window');
            const closeButton = document.getElementById('qc-close-button');
            const messages = document.getElementById('qc-messages');
            const input = document.getElementById('qc-input');
            const sendButton = document.getElementById('qc-send');
            const typingIndicator = document.getElementById('qc-typing');

            let accessToken = null;
            let hasAccess = false;
            let isOpen = false;
            let conversationHistory = [];
            let sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            initializeAccess();

            function showStatus(message, variant = 'info') {
                if (!accessMessage) return;
                if (!message) {
                    accessMessage.textContent = '';
                    accessMessage.style.display = 'none';
                    accessMessage.className = 'qc-access-message';
                    return;
                }
                accessMessage.textContent = message;
                accessMessage.style.display = 'flex';
                accessMessage.className = `qc-access-message qc-${variant}`;
            }

            async function initializeAccess() {
                showStatus('Checking beta accessâ€¦');
                try {
                    const response = await fetch(ACCESS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: memberEmail,
                            is_paid_member: isPaidMember
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Access check failed');
                    }

                    const data = await response.json();
                    if (!data.has_access || !data.access_token) {
                        hasAccess = false;
                        widgetContainer.style.display = 'none';
                        showStatus(data.reason || 'Quality Coach AI is available to beta testers only right now.', 'warning');
                        return;
                    }

                    accessToken = data.access_token;
                    hasAccess = true;
                    window.QUALITY_COACH_SESSION = {
                        token: accessToken,
                        expires_at: data.access_expires_at,
                        granted_via: data.access_granted_via,
                        email: memberEmail
                    };

                    widgetContainer.style.display = 'block';
                    showStatus('');
                } catch (error) {
                    hasAccess = false;
                    widgetContainer.style.display = 'none';
                    showStatus('Unable to verify beta access. Please refresh and try again.', 'error');
                }
            }

            // Toggle chat window
            chatButton.addEventListener('click', function() {
                if (!hasAccess) {
                    showStatus('Quality Coach AI is limited to approved members. Reach out to join the beta.', 'warning');
                    return;
                }

                isOpen = !isOpen;
                if (isOpen) {
                    chatWindow.style.display = 'flex';
                    chatButton.style.display = 'none';
                    input.focus();

                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'quality_coach_opened', {
                            'post_slug': '{{slug}}',
                            'post_title': '{{title}}'
                        });
                    }
                }
            });

            closeButton.addEventListener('click', function() {
                isOpen = false;
                chatWindow.style.display = 'none';
                chatButton.style.display = 'flex';
            });

            // Auto-resize textarea
            input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Send on Enter (Shift+Enter for newline)
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            sendButton.addEventListener('click', sendMessage);

            function sendMessage() {
                if (!hasAccess || !accessToken) {
                    showStatus('Your beta access token expired. Refresh the page to request a new one.', 'warning');
                    return;
                }

                const message = input.value.trim();
                if (!message) return;

                addMessage(message, 'user');
                input.value = '';
                input.style.height = 'auto';

                input.disabled = true;
                sendButton.disabled = true;
                typingIndicator.style.display = 'flex';

                fetch(CHAT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId,
                        history: conversationHistory,
                        context: {
                            post_slug: '{{slug}}',
                            post_title: '{{title}}',
                            member_email: memberEmail
                        }
                    })
                })
                .then(async response => {
                    typingIndicator.style.display = 'none';

                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            hasAccess = false;
                            showStatus('Your beta access expired. Refresh the page to request a new token.', 'warning');
                        }
                        throw new Error('Chat request failed');
                    }

                    const data = await response.json();
                    if (data.answer) {
                        addMessage(data.answer, 'assistant', data.sources, data.small_bet);
                        conversationHistory.push({ role: 'user', content: message });
                        conversationHistory.push({ role: 'assistant', content: data.answer });
                    } else {
                        addMessage('Sorry, I encountered an error. Please try again.', 'error', null, null);
                    }
                })
                .catch(() => {
                    typingIndicator.style.display = 'none';
                    addMessage('Sorry, I\'m having trouble connecting. Please try again later.', 'error');
                })
                .finally(() => {
                    input.disabled = false;
                    sendButton.disabled = false;
                    input.focus();
                });
            }

            function formatMessage(content) {
                return content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/^- (.*?)$/gm, 'â€¢ $1')
                    .replace(/\[(.*?)\]/g, '<span style="color: #64748b; font-size: 0.9em;">[$1]</span>')
                    .replace(/\n/g, '<br>');
            }

            function addMessage(content, role, sources, smallBet) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'qc-message qc-message-' + role;

                const bubble = document.createElement('div');
                bubble.className = 'qc-message-bubble';

                if (role === 'user') {
                    bubble.textContent = content;
                } else {
                    bubble.innerHTML = formatMessage(content);
                }

                messageDiv.appendChild(bubble);

                if (smallBet) {
                    const betDiv = document.createElement('div');
                    betDiv.className = 'qc-small-bet';
                    betDiv.innerHTML = `
                        <div class="qc-bet-header">ðŸ’¡ Small Bet Suggestion</div>
                        <div class="qc-bet-content">
                            ${smallBet.objective ? `<div class="qc-bet-section"><strong>Objective:</strong> ${smallBet.objective}</div>` : ''}
                            ${smallBet.assumption_being_tested ? `<div class="qc-bet-section"><strong>Testing:</strong> ${smallBet.assumption_being_tested}</div>` : ''}
                            ${smallBet.steps && smallBet.steps.length > 0 ? `
                                <div class="qc-bet-section">
                                    <strong>Steps:</strong>
                                    <ol class="qc-bet-list">
                                        ${smallBet.steps.map(step => `<li>${step}</li>`).join('')}
                                    </ol>
                                </div>
                            ` : ''}
                            ${smallBet.signals_to_look_for && smallBet.signals_to_look_for.length > 0 ? `
                                <div class="qc-bet-section">
                                    <strong>Look for:</strong>
                                    <ul class="qc-bet-list">
                                        ${smallBet.signals_to_look_for.map(signal => `<li>${signal}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${smallBet.time_investment ? `<div class="qc-bet-section"><strong>Time:</strong> ${smallBet.time_investment}</div>` : ''}
                        </div>
                    `;
                    messageDiv.appendChild(betDiv);
                }

                if (sources && sources.length > 0) {
                    const sourcesDiv = document.createElement('div');
                    sourcesDiv.className = 'qc-sources';
                    sourcesDiv.innerHTML = '<strong>Sources:</strong> ' + 
                        sources.map(s => s.chapter || s.title).join(', ');
                    messageDiv.appendChild(sourcesDiv);
                }

                messages.appendChild(messageDiv);
                messages.scrollTop = messages.scrollHeight;
            }
        })();
        </script>
    </div>
{{else}}
    <div class="qc-locked-message">
        The Quality Coach AI is available to members only. Sign in to request beta access.
    </div>
{{/if}}
