{{!-- Quality Coach AI - Floating Chat Widget --}}
{{!-- Configure via Ghost Code Injection (Settings â†’ Code Injection â†’ Site Header):
     - allowedEmails: array of email addresses who can see the widget
     - allowPaidMembers: boolean for all paid members
     - apiKey: your API secret key from backend .env
--}}
<script>
    window.QUALITY_COACH_CONFIG = window.QUALITY_COACH_CONFIG || {
        apiKey: '' // REQUIRED: Set this in Code Injection
    };
</script>

{{#if @member.email}}
    <script>
        // Check if this member is allowed to see the widget
        window.QUALITY_COACH_SHOW = false;
        
        // Check allowed emails list (test mode)
        if (window.QUALITY_COACH_CONFIG.allowedEmails && window.QUALITY_COACH_CONFIG.allowedEmails.length > 0) {
            window.QUALITY_COACH_SHOW = window.QUALITY_COACH_CONFIG.allowedEmails.includes('{{@member.email}}');
        }
        // Fallback to paid member check (production mode)
        else if (window.QUALITY_COACH_CONFIG.allowPaidMembers) {
            window.QUALITY_COACH_SHOW = {{#if @member.paid}}true{{else}}false{{/if}};
        }
    </script>
    
    {{!-- Floating Chat Widget --}}
    <div id="quality-coach-widget" style="display: none;">
        <script>
            if (window.QUALITY_COACH_SHOW) {
                document.getElementById('quality-coach-widget').style.display = 'block';
            }
        </script>

        {{!-- Chat Button (initially visible) --}}
        <button id="qc-chat-button" class="qc-chat-button" aria-label="Open Quality Coach AI">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <span class="qc-button-badge">AI</span>
        </button>

        {{!-- Chat Window (hidden by default) --}}
        <div id="qc-chat-window" class="qc-chat-window" style="display: none;">
            {{!-- Header --}}
            <div class="qc-window-header">
                <div class="qc-header-content">
                    <div class="qc-header-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M2 17L12 22L22 17" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M2 12L12 17L22 12" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="qc-header-text">
                        <h3>Quality Coach AI</h3>
                        <p>Ask me anything</p>
                    </div>
                </div>
                <button id="qc-close-button" class="qc-close-button" aria-label="Close chat">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            {{!-- Messages Area --}}
            <div id="qc-messages" class="qc-messages">
                <div class="qc-welcome-message">
                    <div class="qc-welcome-icon">ðŸ‘‹</div>
                    <p><strong>Hi! I'm your Quality Coach AI</strong></p>
                    <p>I'm trained on "The Quality Coach's Handbook". Ask me about quality coaching, systems thinking, or building quality culture.</p>
                </div>
            </div>

            {{!-- Typing Indicator --}}
            <div id="qc-typing" class="qc-typing" style="display: none;">
                <div class="qc-typing-dot"></div>
                <div class="qc-typing-dot"></div>
                <div class="qc-typing-dot"></div>
            </div>

            {{!-- Input Area --}}
            <div class="qc-input-area">
                <textarea 
                    id="qc-input" 
                    class="qc-input" 
                    placeholder="Ask a question..."
                    rows="1"
                    maxlength="500"></textarea>
                <button id="qc-send" class="qc-send-button" aria-label="Send message">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>

            {{!-- Footer --}}
            <div class="qc-window-footer">
                <span>Powered by The Quality Coach's Handbook</span>
            </div>
        </div>

        <script>
        (function() {
            const API_URL = 'https://qchb-chat.fly.dev/api/v1/chat';
            const API_KEY = window.QUALITY_COACH_CONFIG.apiKey;
            
            const chatButton = document.getElementById('qc-chat-button');
            const chatWindow = document.getElementById('qc-chat-window');
            const closeButton = document.getElementById('qc-close-button');
            const messages = document.getElementById('qc-messages');
            const input = document.getElementById('qc-input');
            const sendButton = document.getElementById('qc-send');
            const typingIndicator = document.getElementById('qc-typing');
            
            let isOpen = false;
            let conversationHistory = [];
            let sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Check if API key is configured
            if (!API_KEY) {
                console.error('Quality Coach: API key not configured in Code Injection');
                return;
            }
            
            // Toggle chat window
            chatButton.addEventListener('click', function() {
                isOpen = !isOpen;
                if (isOpen) {
                    chatWindow.style.display = 'flex';
                    chatButton.style.display = 'none';
                    input.focus();
                    
                    // Track opening
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'quality_coach_opened', {
                            'post_slug': '{{slug}}',
                            'post_title': '{{title}}'
                        });
                    }
                }
            });
            
            closeButton.addEventListener('click', function() {
                isOpen = false;
                chatWindow.style.display = 'none';
                chatButton.style.display = 'flex';
            });
            
            // Auto-resize textarea
            input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            // Send on Enter (Shift+Enter for newline)
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            sendButton.addEventListener('click', sendMessage);
            
            function sendMessage() {
                const message = input.value.trim();
                if (!message) return;
                
                // Add user message to UI
                addMessage(message, 'user');
                input.value = '';
                input.style.height = 'auto';
                
                // Disable input while processing
                input.disabled = true;
                sendButton.disabled = true;
                typingIndicator.style.display = 'flex';
                
                // Send to API
                fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId,
                        context: {
                            post_slug: '{{slug}}',
                            post_title: '{{title}}',
                            member_email: '{{@member.email}}'
                        }
                    })
                })
                .then(response => response.json())
                .then(data => {
                    typingIndicator.style.display = 'none';
                    
                    if (data.response) {
                        addMessage(data.response, 'assistant', data.sources);
                        conversationHistory.push({ role: 'user', content: message });
                        conversationHistory.push({ role: 'assistant', content: data.response });
                    } else {
                        addMessage('Sorry, I encountered an error. Please try again.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Chat error:', error);
                    typingIndicator.style.display = 'none';
                    addMessage('Sorry, I\'m having trouble connecting. Please try again later.', 'error');
                })
                .finally(() => {
                    input.disabled = false;
                    sendButton.disabled = false;
                    input.focus();
                });
            }
            
            function addMessage(content, role, sources) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'qc-message qc-message-' + role;
                
                const bubble = document.createElement('div');
                bubble.className = 'qc-message-bubble';
                bubble.textContent = content;
                
                messageDiv.appendChild(bubble);
                
                // Add sources if available
                if (sources && sources.length > 0) {
                    const sourcesDiv = document.createElement('div');
                    sourcesDiv.className = 'qc-sources';
                    sourcesDiv.innerHTML = '<strong>Sources:</strong> ' + 
                        sources.map(s => s.chapter || s.title).join(', ');
                    messageDiv.appendChild(sourcesDiv);
                }
                
                messages.appendChild(messageDiv);
                messages.scrollTop = messages.scrollHeight;
            }
        })();
        </script>
    </div>
{{/if}}
