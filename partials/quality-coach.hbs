{{!-- Quality Coach Companion - Floating Chat Widget --}}
{{!-- Server-side beta access is handled by /api/v1/access/check.
    No API keys or email lists should be injected into the browser. --}}

{{#if @member}}
    <div id="qc-access-message" class="qc-access-message" role="status"></div>
    
    {{!-- Floating Chat Widget --}}
    <div id="quality-coach-widget" class="qc-widget qc-widget--initializing">

        {{!-- Chat Button (initially visible) --}}
        <button 
            id="qc-chat-button" 
            class="qc-chat-button is-loading" 
            type="button"
            aria-label="Open Quality Coach Companion"
            aria-haspopup="dialog"
            aria-controls="qc-chat-window"
            aria-expanded="false"
            aria-disabled="true"
            title="Checking Companion access">
            <span class="qc-chat-button-icon qc-chat-button-icon--chat" aria-hidden="true">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            </span>
            <span class="qc-chat-button-icon qc-chat-button-icon--close" aria-hidden="true">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </span>
        </button>

        {{!-- Chat Window (hidden by default) --}}
        <div id="qc-chat-window" class="qc-chat-window" role="dialog" aria-modal="true" aria-label="Quality Coach Companion">
            <div class="qc-window-handle" aria-hidden="true">
                <span></span>
            </div>
            {{!-- Header --}}
            <div class="qc-window-header">
                <div class="qc-header-content">
                    <div class="qc-header-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M2 17L12 22L22 17" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M2 12L12 17L22 12" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="qc-header-text">
                        <h3>Quality Coach Companion</h3>
                        <p>Get guidance on quality coaching</p>
                    </div>
                </div>
                <button id="qc-close-button" class="qc-close-button" aria-label="Close chat">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            {{!-- Messages Area --}}
            <div id="qc-messages" class="qc-messages">
                <div class="qc-welcome-message">
                    <div class="qc-welcome-icon">ðŸ‘‹</div>
                    <p><strong>Hi! I'm the Quality Coach Companion</strong></p>
                    <p>I'm grounded in "The Quality Coach's Handbook". Ask about systems thinking, coaching moves, or designing your next small bet.</p>
                </div>
            </div>

            <template id="qc-feedback-panel-template">
                <div class="qc-feedback-panel" role="status" aria-live="polite">
                    <div class="qc-feedback-panel-text">How can we make this better?</div>
                    <textarea class="qc-feedback-textarea" rows="3" maxlength="400" placeholder="Share suggestions on how to improve the Companion"></textarea>
                    <div class="qc-feedback-controls">
                        <button type="button" class="qc-feedback-submit">Send feedback</button>
                        <span class="qc-feedback-hint">Goes straight to Anne-Marie.</span>
                    </div>
                </div>
            </template>

            {{!-- Typing Indicator --}}
            <div id="qc-typing" class="qc-typing" style="display: none;">
                <div class="qc-typing-dot"></div>
                <div class="qc-typing-dot"></div>
                <div class="qc-typing-dot"></div>
            </div>

            {{!-- Input Area --}}
            <div class="qc-input-area">
                <textarea 
                    id="qc-input" 
                    class="qc-input" 
                    placeholder="Ask a question..."
                    rows="1"
                    maxlength="500"></textarea>
                <button id="qc-send" class="qc-send-button" aria-label="Send message">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>

            {{!-- Footer --}}
            <div class="qc-window-footer">
                <span>Powered by The Quality Coach's Handbook</span>
            </div>
        </div>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Automatically switch between local and production backend
            const API_BASE = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
                ? 'http://localhost:8000'
                : 'https://qchb-chat.fly.dev';
            
            const ACCESS_URL = `${API_BASE}/api/v1/access/check`;
            const CHAT_URL = `${API_BASE}/api/v1/chat`;
            const memberEmail = '{{@member.email}}';
            const isPaidMember = {{#if @member.paid}}true{{else}}false{{/if}};
            const DEFAULT_PLACEHOLDER = 'Ask a question...';
            const FEEDBACK_PREFIX = 'feedback:';
            const ACCESS_CACHE_PREFIX = 'qc_access_cache:';
            const ACCESS_CACHE_MIN_VALID_MS = 30 * 1000;
            const ACCESS_REFRESH_BUFFER_MS = 5 * 60 * 1000;
            const ACCESS_LAG_MESSAGE_MS = 4000;

            const accessMessage = document.getElementById('qc-access-message');
            const widgetContainer = document.getElementById('quality-coach-widget');
            const chatButton = document.getElementById('qc-chat-button');
            const chatWindow = document.getElementById('qc-chat-window');
            const closeButton = document.getElementById('qc-close-button');
            const messages = document.getElementById('qc-messages');
            const feedbackTemplate = document.getElementById('qc-feedback-panel-template');
            const input = document.getElementById('qc-input');
            const sendButton = document.getElementById('qc-send');
            const typingIndicator = document.getElementById('qc-typing');
            const PORTAL_SELECTORS = [
                '.gh-portal-triggerbtn',
                '.gh-portal-triggerbtn-root',
                '#ghost-portal-root',
                'iframe[src*="ghost" i][title*="portal" i]'
            ];
            const PORTAL_OFFSET_CLASS = 'qc-offset-for-portal';
            const PORTAL_CHECK_INTERVAL_MS = 2000;
            const PORTAL_FALLBACK_TIMEOUT_MS = 5000;

            if (!chatButton || !chatWindow || !input || !sendButton || !closeButton) {
                return;
            }

            if (typeof window !== 'undefined') {
                window.QUALITY_COACH_SESSION = {
                    status: 'pending',
                    email: memberEmail
                };
            }

            // Initialize Quality Coach Client
            // Ensure QualityCoachClient is available
            if (typeof QualityCoachClient === 'undefined') {
                console.error('QualityCoachClient not loaded');
                return;
            }

            const client = new QualityCoachClient({
                apiBase: API_BASE,
                storageKey: 'qc_thread_id'
            });
            
            // Initialize thread ID immediately
            const clientThreadId = client.init();

            let accessToken = null;
            let hasAccess = false;
            let isOpen = false;
            let isLocked = false;
            let conversationHistory = [];
            
            let portalObserver = null;
            let portalInterval = null;
            let portalFallbackTimer = null;
            let feedbackUnlocked = false;
            let feedbackPanel = null;
            let feedbackTextarea = null;
            let feedbackSubmitButton = null;
            let lastAssistantMessage = null;
            let accessRefreshTimer = null;
            let accessLagTimer = null;

            chatButton.classList.add('is-loading');

            initializeAccess();
            monitorPortalTrigger();
            if (input) {
                input.placeholder = DEFAULT_PLACEHOLDER;
            }

            function showStatus(message, variant = 'info') {
                if (!accessMessage) return;
                if (!message) {
                    accessMessage.textContent = '';
                    accessMessage.style.display = 'none';
                    accessMessage.className = 'qc-access-message';
                    return;
                }
                accessMessage.textContent = message;
                accessMessage.style.display = 'flex';
                accessMessage.className = `qc-access-message qc-${variant}`;
            }

            function startAccessLagTimer() {
                if (accessLagTimer) {
                    clearTimeout(accessLagTimer);
                }
                accessLagTimer = setTimeout(() => {
                    showStatus('Still checking your Companion accessâ€¦', 'info');
                }, ACCESS_LAG_MESSAGE_MS);
            }

            function stopAccessLagTimer() {
                if (accessLagTimer) {
                    clearTimeout(accessLagTimer);
                    accessLagTimer = null;
                }
            }

            function attemptRestoreCachedAccess() {
                const cached = loadAccessCache();
                if (!cached) {
                    return false;
                }
                if (!canUseCachedAccess(cached)) {
                    clearAccessCache();
                    return false;
                }
                applyAccessSuccess({
                    access_token: cached.access_token,
                    access_expires_at: cached.access_expires_at,
                    access_granted_via: cached.access_granted_via,
                    is_beta_tester: cached.is_beta_tester,
                    is_paid_member: cached.is_paid_member
                }, {
                    source: 'cache',
                    skipCache: true
                });
                return true;
            }

            function applyAccessSuccess(data, { source = 'network', skipCache = false } = {}) {
                if (!data || !data.access_token) {
                    return;
                }
                accessToken = data.access_token;
                // Ensure client has the token
                client.setAccessToken(accessToken);
                
                hasAccess = true;
                isLocked = false;
                if (widgetContainer) {
                    widgetContainer.classList.remove('qc-widget--hidden');
                    widgetContainer.classList.remove('qc-widget--initializing');
                }
                window.QUALITY_COACH_SESSION = {
                    token: accessToken,
                    expires_at: data.access_expires_at,
                    granted_via: data.access_granted_via,
                    email: memberEmail,
                    status: 'ready',
                    source,
                    is_beta_tester: data.is_beta_tester,
                    is_paid_member: data.is_paid_member
                };

                setButtonAccessibility({ disabled: false, loading: false, tooltip: 'Open Quality Coach Companion' });
                if (!skipCache) {
                    saveAccessCache({
                        access_token: data.access_token,
                        access_expires_at: data.access_expires_at,
                        access_granted_via: data.access_granted_via,
                        is_beta_tester: data.is_beta_tester,
                        is_paid_member: data.is_paid_member
                    });
                }
                scheduleAccessRefresh(data.access_expires_at);
                showStatus('');
                
                // Load history if available
                loadConversationHistory();
            }

            function scheduleAccessRefresh(expiresAt) {
                if (accessRefreshTimer) {
                    clearTimeout(accessRefreshTimer);
                    accessRefreshTimer = null;
                }
                if (!expiresAt) return;
                const expiryTime = Date.parse(expiresAt);
                if (!expiryTime) return;
                const delay = expiryTime - Date.now() - ACCESS_REFRESH_BUFFER_MS;
                if (delay <= 0) {
                    accessRefreshTimer = setTimeout(() => {
                        refreshAccessToken('expired');
                    }, 1000);
                    return;
                }
                accessRefreshTimer = setTimeout(() => {
                    refreshAccessToken('scheduled');
                }, delay);
            }

            async function refreshAccessToken(reason = 'scheduled') {
                try {
                    await performAccessCheck({ silent: true });
                } catch (error) {
                    if (typeof console !== 'undefined' && console.debug) {
                        console.debug('Companion access refresh failed', reason, error);
                    }
                }
            }

            function getCacheKey() {
                return `${ACCESS_CACHE_PREFIX}${memberEmail || 'anonymous'}`;
            }

            function loadAccessCache() {
                if (typeof sessionStorage === 'undefined') return null;
                try {
                    const raw = sessionStorage.getItem(getCacheKey());
                    if (!raw) return null;
                    return JSON.parse(raw);
                } catch (error) {
                    clearAccessCache();
                    return null;
                }
            }

            function saveAccessCache(payload) {
                if (typeof sessionStorage === 'undefined' || !payload) return;
                const cacheEntry = {
                    ...payload,
                    cached_at: new Date().toISOString(),
                    member_email: memberEmail
                };
                try {
                    sessionStorage.setItem(getCacheKey(), JSON.stringify(cacheEntry));
                } catch (error) {
                    // Ignore quota errors silently
                }
            }

            function clearAccessCache() {
                if (typeof sessionStorage === 'undefined') return;
                sessionStorage.removeItem(getCacheKey());
                if (accessRefreshTimer) {
                    clearTimeout(accessRefreshTimer);
                    accessRefreshTimer = null;
                }
            }

            function canUseCachedAccess(entry) {
                if (!entry || !entry.access_token || !entry.access_expires_at) {
                    return false;
                }
                const expiryTime = Date.parse(entry.access_expires_at);
                if (!expiryTime) {
                    return false;
                }
                if (expiryTime - Date.now() <= ACCESS_CACHE_MIN_VALID_MS) {
                    return false;
                }
                return true;
            }

            function monitorPortalTrigger() {
                if (typeof document === 'undefined') return;

                updatePortalOffset();

                if (typeof MutationObserver !== 'undefined') {
                    if (portalObserver) {
                        portalObserver.disconnect();
                    }
                    portalObserver = new MutationObserver(() => {
                        updatePortalOffset();
                    });
                    portalObserver.observe(document.body, {
                        childList: true,
                        subtree: true
                    });
                }

                if (!portalInterval) {
                    portalInterval = setInterval(() => {
                        updatePortalOffset();
                    }, PORTAL_CHECK_INTERVAL_MS);
                }

                if (!portalFallbackTimer) {
                    portalFallbackTimer = setTimeout(() => {
                        if (document.body && !document.body.classList.contains(PORTAL_OFFSET_CLASS)) {
                            document.body.classList.add(PORTAL_OFFSET_CLASS);
                        }
                    }, PORTAL_FALLBACK_TIMEOUT_MS);
                }
            }

            function updatePortalOffset() {
                if (!document.body) return;
                const portalElement = findPortalElement();
                const hasPortal = Boolean(portalElement);
                document.body.classList.toggle(PORTAL_OFFSET_CLASS, hasPortal);

                if (hasPortal && portalFallbackTimer) {
                    clearTimeout(portalFallbackTimer);
                    portalFallbackTimer = null;
                }

                if (hasPortal && portalInterval) {
                    clearInterval(portalInterval);
                    portalInterval = null;
                }
            }

            function findPortalElement() {
                for (const selector of PORTAL_SELECTORS) {
                    if (!selector) continue;
                    const el = document.querySelector(selector);
                    if (el) {
                        return el;
                    }
                }
                return null;
            }

            async function loadConversationHistory() {
                if (!clientThreadId || !accessToken) return;
                
                // Avoid loading if we already have history in memory (e.g. from previous session in same window)
                if (conversationHistory.length > 0) return;

                try {
                    const messages = await client.getHistory();
                    
                    if (Array.isArray(messages) && messages.length > 0) {
                        // Clear welcome message if we have history
                        const welcomeMsg = document.querySelector('.qc-welcome-message');
                        if (welcomeMsg) welcomeMsg.style.display = 'none';

                        messages.forEach(msg => {
                            addMessage(msg.content, msg.role);
                            conversationHistory.push({ role: msg.role, content: msg.content });
                        });
                    }
                } catch (error) {
                    console.debug('Failed to load conversation history', error);
                }
            }

            async function initializeAccess() {
                const restored = attemptRestoreCachedAccess();
                if (restored) {
                    return;
                }
                await performAccessCheck();
            }

            async function performAccessCheck({ silent = false } = {}) {
                if (!silent) {
                    showStatus('Checking Companion accessâ€¦');
                    startAccessLagTimer();
                }

                try {
                    const data = await client.checkAccess(memberEmail);

                    if (widgetContainer) {
                        widgetContainer.classList.remove('qc-widget--initializing');
                    }

                    if (!data.has_access || !data.access_token) {
                        hasAccess = false;
                        isLocked = true;
                        hideChatWidget();
                        showStatus(data.reason || 'Quality Coach Companion is available to beta testers only right now.', 'warning');
                        clearAccessCache();
                        return false;
                    }

                    // Update client with token
                    client.setAccessToken(data.access_token);

                    applyAccessSuccess(data, {
                        source: silent ? 'refresh' : 'network'
                    });
                    return true;
                } catch (error) {
                    hasAccess = false;
                    isLocked = true;
                    if (widgetContainer) {
                        widgetContainer.classList.remove('qc-widget--initializing');
                    }
                    setButtonAccessibility({ disabled: true, loading: false, tooltip: 'Unable to verify beta access. Please refresh and try again.' });
                    if (!silent) {
                        showStatus('Unable to verify beta access. Please refresh and try again.', 'error');
                    }
                    clearAccessCache();
                    return false;
                } finally {
                    if (!silent) {
                        stopAccessLagTimer();
                    }
                }
            }

            function setButtonAccessibility({ disabled, loading, tooltip }) {
                if (!chatButton) return;
                chatButton.classList.toggle('is-loading', Boolean(loading));
                if (typeof disabled !== 'undefined') {
                    if (disabled) {
                        chatButton.setAttribute('aria-disabled', 'true');
                        chatButton.disabled = true;
                    } else {
                        chatButton.removeAttribute('aria-disabled');
                        chatButton.disabled = false;
                    }
                }
                if (tooltip) {
                    chatButton.setAttribute('title', tooltip);
                } else {
                    chatButton.removeAttribute('title');
                }
            }

            function hideChatWidget() {
                if (widgetContainer) {
                    widgetContainer.classList.add('qc-widget--hidden');
                }
                setButtonAccessibility({ disabled: true, loading: false });
            }

            // Toggle chat window
            chatButton.addEventListener('click', function() {
                if (chatButton.getAttribute('aria-disabled') === 'true') {
                    const lockedCopy = isLocked
                        ? 'Quality Coach Companion is limited to approved members. Reach out to join the beta.'
                        : 'Still checking your Companion accessâ€¦';
                    showStatus(lockedCopy, isLocked ? 'warning' : 'info');
                    return;
                }

                if (isOpen) {
                    closeChatWindow();
                } else {
                    openChatWindow();
                }
            });

            closeButton.addEventListener('click', closeChatWindow);

            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && isOpen) {
                    closeChatWindow();
                }
            });

            function openChatWindow() {
                if (!hasAccess) {
                    showStatus('Quality Coach Companion is limited to approved members. Reach out to join the beta.', 'warning');
                    return;
                }
                isOpen = true;
                chatWindow.classList.add('is-visible');
                chatButton.classList.add('is-open');
                chatButton.setAttribute('aria-expanded', 'true');
                chatButton.setAttribute('aria-label', 'Close Quality Coach Companion');
                input.focus();

                if (typeof gtag !== 'undefined') {
                    gtag('event', 'quality_coach_opened', {
                        'post_slug': '{{slug}}',
                        'post_title': '{{title}}'
                    });
                }
            }

            function closeChatWindow() {
                isOpen = false;
                chatWindow.classList.remove('is-visible');
                chatButton.classList.remove('is-open');
                chatButton.setAttribute('aria-expanded', 'false');
                chatButton.setAttribute('aria-label', 'Open Quality Coach Companion');
                chatButton.focus();
            }

            // Auto-resize textarea
            input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Send on Enter (Shift+Enter for newline)
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            sendButton.addEventListener('click', sendMessage);

            function sendMessage(options = {}) {
                if (!hasAccess || !accessToken) {
                    showStatus('Your Companion access token expired. Refresh the page to request a new one.', 'warning');
                    return;
                }

                const { messageOverride = null, isFeedbackOverride = null } = options;
                const usingPrimaryInput = messageOverride === null;
                const sourceValue = usingPrimaryInput ? input.value : messageOverride;
                const rawMessage = (sourceValue || '').trim();
                if (!rawMessage) return;

                const hasLegacyFeedbackPrefix = usingPrimaryInput && rawMessage.toLowerCase().startsWith(FEEDBACK_PREFIX);
                const cleanedMessage = hasLegacyFeedbackPrefix
                    ? rawMessage.slice(FEEDBACK_PREFIX.length).trimStart()
                    : rawMessage;
                const isFeedback = typeof isFeedbackOverride === 'boolean'
                    ? isFeedbackOverride
                    : hasLegacyFeedbackPrefix;

                if (isFeedback && !cleanedMessage) {
                    showStatus('Share a short note before sending feedback.', 'warning');
                    return;
                }

                if (isFeedback) {
                    showStatus('Appreciate the Companion feedback â€” it will go straight to Anne-Marie.', 'info');
                }

                const displayMessage = isFeedback ? cleanedMessage : rawMessage;
                addMessage(displayMessage, 'user', null, null, isFeedback);

                if (usingPrimaryInput) {
                    input.value = '';
                    input.style.height = 'auto';
                } else if (feedbackTextarea) {
                    feedbackTextarea.value = '';
                }

                if (usingPrimaryInput) {
                    input.disabled = true;
                    sendButton.disabled = true;
                } else {
                    setFeedbackPanelLoading(true);
                }
                typingIndicator.style.display = 'flex';

                client.sendMessage(cleanedMessage, conversationHistory, {
                    post_slug: '{{slug}}',
                    post_title: '{{title}}',
                    member_email: memberEmail,
                    is_feedback: isFeedback
                })
                .then(data => {
                    typingIndicator.style.display = 'none';

                    if (data.answer) {
                        addMessage(data.answer, 'assistant', data.sources, data.small_bet);
                        conversationHistory.push({ role: 'user', content: cleanedMessage });
                        conversationHistory.push({ role: 'assistant', content: data.answer });
                        unlockFeedbackPanel();
                        if (isFeedback && typeof gtag !== 'undefined') {
                            gtag('event', 'quality_coach_feedback_submitted', {
                                'post_slug': '{{slug}}',
                                'post_title': '{{title}}'
                            });
                        }
                    } else {
                        addMessage('Sorry, I encountered an error. Please try again.', 'error', null, null);
                    }
                })
                .catch(error => {
                    typingIndicator.style.display = 'none';
                    
                    if (error.message.includes('401') || error.message.includes('403')) {
                        hasAccess = false;
                        isLocked = true;
                        showStatus('Your Companion access expired. Refresh the page to request a new token.', 'warning');
                        setButtonAccessibility({ disabled: true, loading: false, tooltip: 'Access expired - refresh to continue.' });
                    } else {
                        addMessage('Sorry, I\'m having trouble connecting. Please try again later.', 'error');
                    }
                })
                .finally(() => {
                    if (usingPrimaryInput) {
                        input.disabled = false;
                        sendButton.disabled = false;
                        input.focus();
                    } else {
                        setFeedbackPanelLoading(false);
                        if (feedbackTextarea) {
                            feedbackTextarea.focus();
                        }
                    }
                });
            }

            function unlockFeedbackPanel() {
                if (feedbackUnlocked) return;
                feedbackUnlocked = true;
                if (widgetContainer) {
                    widgetContainer.classList.add('qc-widget--feedback-ready');
                }
                ensureFeedbackPanelPosition();
            }

            function getFeedbackPanel() {
                if (feedbackPanel) return feedbackPanel;
                if (!feedbackTemplate) return null;
                const templateContent = feedbackTemplate.content || feedbackTemplate;
                const sourceNode = templateContent.firstElementChild;
                if (!sourceNode) return null;
                feedbackPanel = sourceNode.cloneNode(true);
                feedbackTextarea = feedbackPanel.querySelector('.qc-feedback-textarea');
                feedbackSubmitButton = feedbackPanel.querySelector('.qc-feedback-submit');

                if (feedbackTextarea) {
                    feedbackTextarea.addEventListener('keydown', event => {
                        if ((event.metaKey || event.ctrlKey) && event.key === 'Enter') {
                            event.preventDefault();
                            submitFeedbackFromPanel();
                        }
                    });
                }

                if (feedbackSubmitButton) {
                    feedbackSubmitButton.addEventListener('click', submitFeedbackFromPanel);
                }

                return feedbackPanel;
            }

            function ensureFeedbackPanelPosition() {
                if (!feedbackUnlocked || !messages || !lastAssistantMessage) return;
                const panel = getFeedbackPanel();
                if (!panel) return;

                if (panel.parentNode && panel.parentNode !== messages) {
                    panel.parentNode.removeChild(panel);
                }

                lastAssistantMessage.insertAdjacentElement('afterend', panel);
                messages.scrollTop = messages.scrollHeight;
            }

            function submitFeedbackFromPanel() {
                if (!feedbackTextarea) return;
                const note = feedbackTextarea.value.trim();
                if (!note) {
                    showStatus('Add a short note before sending feedback.', 'warning');
                    feedbackTextarea.focus();
                    return;
                }
                sendMessage({
                    messageOverride: note,
                    isFeedbackOverride: true
                });
            }

            function setFeedbackPanelLoading(isLoading) {
                if (feedbackPanel) {
                    feedbackPanel.classList.toggle('is-loading', Boolean(isLoading));
                }
                if (feedbackTextarea) {
                    feedbackTextarea.disabled = Boolean(isLoading);
                }
                if (feedbackSubmitButton) {
                    feedbackSubmitButton.disabled = Boolean(isLoading);
                }
            }


            function formatMessage(content) {
                return content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/^- (.*?)$/gm, 'â€¢ $1')
                    .replace(/\[(.*?)\]/g, '<span style="color: #64748b; font-size: 0.9em;">[$1]</span>')
                    .replace(/\n/g, '<br>');
            }

            function addMessage(content, role, sources, smallBet, isFeedbackMessage = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'qc-message qc-message-' + role;

                const bubble = document.createElement('div');
                bubble.className = 'qc-message-bubble';

                if (role === 'user') {
                    bubble.textContent = content;
                } else {
                    bubble.innerHTML = formatMessage(content);
                }

                if (isFeedbackMessage) {
                    messageDiv.classList.add('qc-message-feedback');
                    const feedbackLabel = document.createElement('div');
                    feedbackLabel.className = 'qc-feedback-message-label';
                    feedbackLabel.textContent = 'Feedback sent to Anne-Marie';
                    messageDiv.appendChild(feedbackLabel);
                }

                messageDiv.appendChild(bubble);

                if (smallBet) {
                    const betDiv = document.createElement('div');
                    betDiv.className = 'qc-small-bet';
                    betDiv.innerHTML = `
                        <div class="qc-bet-header">ðŸ’¡ Small Bet Suggestion</div>
                        <div class="qc-bet-content">
                            ${smallBet.objective ? `<div class="qc-bet-section"><strong>Objective:</strong> ${smallBet.objective}</div>` : ''}
                            ${smallBet.assumption_being_tested ? `<div class="qc-bet-section"><strong>Testing:</strong> ${smallBet.assumption_being_tested}</div>` : ''}
                            ${smallBet.steps && smallBet.steps.length > 0 ? `
                                <div class="qc-bet-section">
                                    <strong>Steps:</strong>
                                    <ol class="qc-bet-list">
                                        ${smallBet.steps.map(step => `<li>${step}</li>`).join('')}
                                    </ol>
                                </div>
                            ` : ''}
                            ${smallBet.signals_to_look_for && smallBet.signals_to_look_for.length > 0 ? `
                                <div class="qc-bet-section">
                                    <strong>Look for:</strong>
                                    <ul class="qc-bet-list">
                                        ${smallBet.signals_to_look_for.map(signal => `<li>${signal}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${smallBet.time_investment ? `<div class="qc-bet-section"><strong>Time:</strong> ${smallBet.time_investment}</div>` : ''}
                        </div>
                    `;
                    messageDiv.appendChild(betDiv);
                }

                if (sources && sources.length > 0) {
                    const sourcesDiv = document.createElement('div');
                    sourcesDiv.className = 'qc-sources';
                    sourcesDiv.innerHTML = '<strong>Sources:</strong> ' + 
                        sources.map(s => s.chapter || s.title).join(', ');
                    messageDiv.appendChild(sourcesDiv);
                }

                if (role === 'assistant') {
                    lastAssistantMessage = messageDiv;
                    if (feedbackUnlocked) {
                        ensureFeedbackPanelPosition();
                    }
                }

                messages.appendChild(messageDiv);
                messages.scrollTop = messages.scrollHeight;
            }
        });
        </script>
    </div>
{{else}}
    <div class="qc-locked-message">
        The Quality Coach Companion is available to members only. Sign in to request beta access.
    </div>
{{/if}}
