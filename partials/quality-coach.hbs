{{!-- Quality Coach Researcher - Floating Chat Widget --}}
{{!-- Server-side beta access is handled by /api/v1/access/check.
    No API keys or email lists should be injected into the browser. --}}

{{!-- Quality Coach Researcher - Floating Chat Widget --}}
{{!-- Server-side beta access is handled by /api/v1/access/check.
    No API keys or email lists should be injected into the browser. --}}

{{!-- Quality Coach Researcher - Floating Chat Widget --}}
{{!-- Server-side beta access is handled by /api/v1/access/check.
    No API keys or email lists should be injected into the browser. --}}

    <div id="qc-access-message" class="qc-access-message" role="status"></div>
    
    {{!-- Floating Chat Widget --}}
    <div id="quality-coach-widget" class="qc-widget qc-widget--initializing">

        {{!-- Chat Button (initially visible) --}}
        <div class="qc-chat-button-wrapper">
            {{!-- Rotating circular text ring --}}
            <svg class="qc-circular-text" viewBox="0 0 100 100" aria-hidden="true">
                <defs>
                    <path id="qc-circle-path" d="M 50,50 m -38,0 a 38,38 0 1,1 76,0 a 38,38 0 1,1 -76,0" fill="none"/>
                </defs>
                <text class="qc-circular-text-label">
                    <textPath href="#qc-circle-path" startOffset="0%">ASK THE BOOK â€¢ ASK THE BOOK â€¢ </textPath>
                </text>
            </svg>
            
            <button 
                id="qc-chat-button" 
                class="qc-chat-button is-loading" 
                type="button"
                aria-label="Open Quality Coach Researcher"
                aria-haspopup="dialog"
                aria-controls="qc-chat-window"
                aria-expanded="false"
                aria-disabled="true"
                title="Checking access">
                <span class="qc-chat-button-icon qc-chat-button-icon--chat" aria-hidden="true">
                    <img src="https://www.annemariecharrett.com/content/images/size/w720/2025/07/qualitycoachbook.svg" alt="Quality Coach Handbook" class="qc-book-icon">
                </span>
                <span class="qc-chat-button-icon qc-chat-button-icon--close" aria-hidden="true">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </span>
            </button>
        </div>

        {{!-- Chat Window (hidden by default) --}}
        <div id="qc-chat-window" class="qc-chat-window" role="dialog" aria-modal="true" aria-label="Quality Coach Researcher">
            <div class="qc-window-handle" aria-hidden="true">
                <span></span>
            </div>
            {{!-- Header --}}
            <div class="qc-window-header">
                <div class="qc-header-content">
                    <div class="qc-header-brand">
                        <img src="https://www.annemariecharrett.com/content/images/size/w720/2025/07/qualitycoachbook.svg" alt="Quality Coach Handbook" class="qc-header-book-icon">
                        <h3 class="qc-header-title">Quality Coach <span class="qc-header-subtitle">Researcher</span></h3>
                    </div>
                    {{!-- Persona Badge - Always Visible --}}
                    <div class="qc-persona-badge" id="qc-persona-badge">
                        <button class="qc-persona-button" id="qc-persona-button" type="button" aria-haspopup="true" aria-expanded="false">
                            <span class="qc-persona-prefix" id="qc-persona-prefix">Tailored for:</span>
                            <span class="qc-persona-current" id="qc-persona-label">Quality Coach</span>
                            <svg class="qc-persona-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                        {{!-- Compact List Popover --}}
                        <div class="qc-persona-popover" id="qc-persona-popover" style="display: none;">
                            <div class="qc-popover-header">
                                <span class="qc-popover-title">Your role</span>
                                <button class="qc-popover-close" id="qc-popover-close" type="button" aria-label="Close">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>
                            <div class="qc-persona-list">
                                <button class="qc-persona-option" data-persona="QUALITY_COACH">
                                    <span class="qc-option-emoji">ðŸŽ¯</span>
                                    <span class="qc-option-name">Quality Coach</span>
                                    <span class="qc-option-check">âœ“</span>
                                </button>
                                <button class="qc-persona-option" data-persona="ENGINEERING_MANAGER">
                                    <span class="qc-option-emoji">ðŸ‘”</span>
                                    <span class="qc-option-name">Engineering Manager</span>
                                    <span class="qc-option-check">âœ“</span>
                                </button>
                                <button class="qc-persona-option" data-persona="DELIVERY_LEAD">
                                    <span class="qc-option-emoji">ðŸ“Š</span>
                                    <span class="qc-option-name">Delivery Lead</span>
                                    <span class="qc-option-check">âœ“</span>
                                </button>
                                <button class="qc-persona-option" data-persona="CEO_EXECUTIVE">
                                    <span class="qc-option-emoji">ðŸ’¼</span>
                                    <span class="qc-option-name">CEO/Executive</span>
                                    <span class="qc-option-check">âœ“</span>
                                </button>
                                <button class="qc-persona-option" data-persona="SOFTWARE_ENGINEER">
                                    <span class="qc-option-emoji">ðŸ’»</span>
                                    <span class="qc-option-name">Software Engineer</span>
                                    <span class="qc-option-check">âœ“</span>
                                </button>
                                <button class="qc-persona-option" data-persona="TEST_LEAD">
                                    <span class="qc-option-emoji">ðŸ§ª</span>
                                    <span class="qc-option-name">Test Lead</span>
                                    <span class="qc-option-check">âœ“</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="qc-close-button" class="qc-close-button" aria-label="Close chat">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            {{!-- Messages Area --}}
            <div id="qc-messages" class="qc-messages">
                <div class="qc-welcome-message">
                    <p><img src="https://www.annemariecharrett.com/content/images/size/w720/2025/07/qualitycoachbook.svg" alt="" class="qc-welcome-book-icon"> <strong>Welcome{{#if @member.name}}, {{@member.name}}{{/if}}!</strong> I'll help you explore Anne-Marie's Quality Coach's Handbook.</p>
                    <div id="qc-example-questions-container" style="display: none;">
                        <p class="qc-welcome-hint">Try asking:</p>
                        <div class="qc-example-questions">
                            <button class="qc-example-question" data-question="How do I start quality coaching in my team?">How do I start quality coaching in my team?</button>
                            <button class="qc-example-question" data-question="What workshop should I run first?">What workshop should I run first?</button>
                            <button class="qc-example-question" data-question="How can I improve test automation?">How can I improve test automation?</button>
                        </div>
                        <p class="qc-welcome-hint" style="margin-top: 12px; font-style: italic; opacity: 0.8;">...or try your own question</p>
                    </div>
                </div>

            </div>

            {{!-- Typing Indicator --}}
            <div id="qc-typing" class="qc-typing" style="display: none;">
                <div class="qc-typing-dot"></div>
                <div class="qc-typing-dot"></div>
                <div class="qc-typing-dot"></div>
            </div>

            {{!-- Input Area --}}
            <div class="qc-input-area">
                <textarea
                    id="qc-input"
                    class="qc-input"
                    placeholder="Ask a question..."
                    rows="1"
                    maxlength="500"></textarea>
                <button id="qc-send" class="qc-send-button" aria-label="Send message">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>

            {{!-- Footer --}}
            <div class="qc-window-footer">
                <span class="qc-footer-disclaimer">Grounded in the Handbook, supplemented by coaching expertise</span>
                <span id="qc-token-usage" class="qc-token-usage" style="display: none;"></span>
            </div>
        </div>

        {{!-- Quality Coach JS libraries are bundled in main.min.js --}}
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Determine API Base URL
            // Priority:
            // 1. Global override (window.QUALITY_COACH_API_BASE) - set via Ghost Code Injection
            // 2. Localhost detection -> Docker Backend
            // 3. Default -> Production Backend
            const API_BASE = window.QUALITY_COACH_API_BASE || 
                ((window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
                ? 'http://localhost:8000'
                : 'https://qchb-chat.fly.dev');

            if (window.QualityCoach && window.QualityCoach.UI) {
                new window.QualityCoach.UI({
                    apiBase: API_BASE,
                    memberEmail: '{{@member.email}}',
                    isPaidMember: {{#if @member.paid}}true{{else}}false{{/if}},
                    postSlug: '{{slug}}',
                    postTitle: '{{title}}'
                });
            } else {
                console.error('QualityCoach.UI not loaded');
            }
        });
        </script>
    </div>
